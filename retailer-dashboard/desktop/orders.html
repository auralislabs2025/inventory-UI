<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orders - Retailer Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="auth.js"></script>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <h2>InventoryPro</h2>
    <div class="role-label">RETAILERS</div>
    
    <div class="nav-section">
      <div class="nav-section-title">MENU</div>
      <ul>
        <li><a href="index.html">Dashboard</a></li>
        <li><a href="marketspace.html">Market Space</a></li>
        <li><a href="inventory.html">Inventory</a></li>
      </ul>
    </div>
    
    <div class="nav-section">
      <div class="nav-section-title">PROCUREMENT</div>
      <ul>
        <li><a href="cart.html">My Cart<span class="nav-badge cart-badge" style="display: none;">0</span></a></li>
        <li class="active"><a href="orders.html">My Orders</a></li>
        <li><a href="invoices.html">Invoices</a></li>
        <li><a href="quotes.html">Active Quotes</a></li>
      </ul>
    </div>
    
    <div class="nav-section">
      <div class="nav-section-title">ACCOUNT</div>
      <ul>
        <li><a href="settings.html">Settings</a></li>
      </ul>
    </div>
  </aside>

  <main class="main">
    <header class="topbar">
      <h1>My Orders</h1>
      <input type="text" placeholder="Search by SKU, Product or Brand..." class="global-search" id="globalSearch">
      <div class="user-info">
        <select id="themeSelect" onchange="changeTheme(this.value)">
          <option value="">Light</option>
          <option value="dark">Dark</option>
        </select>
        <div class="user" id="userDisplay">
          <div class="user-name">Retailer Admin</div>
          <div class="user-role">Retailer</div>
        </div>
        <div class="user-avatar" id="userAvatar">RA</div>
        <button onclick="logout()" style="padding: 8px 16px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); cursor: pointer; margin-left: 10px; font-size: 0.9rem;">Logout</button>
      </div>
    </header>

    <section class="content">
      <div class="page-header">
        <h1>Orders</h1>
        <div>
          <button class="btn btn-primary" onclick="openModal('newOrderModal')">+ New Order</button>
        </div>
      </div>

      <div class="filters">
        <input type="text" placeholder="Search orders..." id="searchInput" class="search-bar" onkeyup="filterTable()">
        <select id="statusFilter" onchange="filterTable()">
          <option value="">All Status</option>
          <option>Pending</option>
          <option>Processing</option>
          <option>Shipped</option>
          <option>Delivered</option>
          <option>Cancelled</option>
        </select>
        <button class="btn" onclick="clearFilters()">Clear Filters</button>
      </div>

      <div class="table-container">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Source</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersBody">
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- Modals -->
<div class="modal" id="newOrderModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal()">×</button>
    <h2>Create New Order</h2>
    <form onsubmit="createOrder(event)">
      <div class="form-group">
        <label>Customer Name</label>
        <input type="text" name="customer" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Number of Items</label>
          <input type="number" name="items" value="1" min="1" required>
        </div>
        <div class="form-group">
          <label>Total Amount (₹)</label>
          <input type="number" name="total" step="0.01" min="0" required>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Create Order</button>
    </form>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="common.js"></script>
<script>
  let orders = JSON.parse(localStorage.getItem('retailer_orders') || '[]');

  function renderTable(){
    const tbody = document.getElementById('ordersBody');
    if(orders.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">No orders found. Create a new order or checkout from cart.</td></tr>';
      return;
    }
    
    tbody.innerHTML = orders.map(order => {
      // Handle items - can be array (from cart) or number (manual order)
      const itemCount = Array.isArray(order.items) ? order.items.length : order.items;
      const itemDisplay = Array.isArray(order.items) ? `${order.items.length} item${order.items.length !== 1 ? 's' : ''}` : `${order.items} item${order.items !== 1 ? 's' : ''}`;
      
      // Handle source - can be customer (manual) or "Market Space" (from cart)
      const source = order.customer || 'Market Space';
      
      // Handle total - ensure it's a number
      const total = typeof order.total === 'number' ? order.total : parseFloat(order.total) || 0;
      
      return `
        <tr>
          <td><strong>${order.orderId || 'N/A'}</strong></td>
          <td>${source}</td>
          <td>${itemDisplay}</td>
          <td>₹${total.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
          <td><span class="status-badge status-${(order.status || 'Pending').toLowerCase()}">${order.status || 'Pending'}</span></td>
          <td>${order.date || 'N/A'}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="updateStatus(${order.id}, '${order.status || 'Pending'}')">Update</button>
            <button class="btn btn-sm btn-danger" onclick="deleteOrder(${order.id})">Delete</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  function filterTable(){
    const term = document.getElementById('searchInput').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#ordersBody tr');
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const rowStatus = row.cells[4].textContent.trim();
      const match = text.includes(term) && (status === '' || rowStatus === status);
      row.style.display = match ? '' : 'none';
    });
  }

  function clearFilters(){
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    filterTable();
  }

  function createOrder(e){
    e.preventDefault();
    const form = e.target;
    const newOrder = {
      id: Date.now(),
      orderId: '#ORD-' + (1000 + orders.length + 1),
      customer: form.customer.value,
      items: parseInt(form.items.value),
      total: parseFloat(form.total.value),
      status: 'Pending',
      date: new Date().toISOString().split('T')[0]
    };
    orders.push(newOrder);
    localStorage.setItem('retailer_orders', JSON.stringify(orders));
    renderTable();
    showToast('Order created!');
    closeModal();
    form.reset();
  }

  function updateStatus(id, currentStatus){
    const statuses = ['Pending', 'Processing', 'Shipped', 'Delivered'];
    const currentIndex = statuses.indexOf(currentStatus);
    const nextStatus = currentIndex < statuses.length - 1 ? statuses[currentIndex + 1] : currentStatus;
    const order = orders.find(o => o.id === id);
    if(order){
      order.status = nextStatus;
      localStorage.setItem('retailer_orders', JSON.stringify(orders));
      renderTable();
      showToast('Order status updated!');
    }
  }

  function deleteOrder(id){
    if(confirm('Are you sure you want to delete this order?')){
      orders = orders.filter(o => o.id !== id);
      localStorage.setItem('retailer_orders', JSON.stringify(orders));
      renderTable();
      showToast('Order deleted!');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    renderTable();
  });
</script>
</body>
</html>

