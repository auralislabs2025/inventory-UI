<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purchase Orders - InventoryPro</title>
  <style>
    :root{--primary:#4361ee;--success:#06d6a0;--warning:#ff9f1c;--danger:#ef476f;--dark:#2c3e50;--light:#f8f9fa}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#f8f9fa;color:#333}
    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;background:#2c3e50;color:white;padding:20px 0;flex-shrink:0}
    .sidebar .logo{padding:0 25px;font-size:1.6rem;font-weight:bold;margin-bottom:30px}
    .sidebar ul{list-style:none}
    .sidebar li a{display:block;padding:15px 25px;color:white;text-decoration:none}
    .sidebar li.active,.sidebar li:hover{background:#34495e}
    .main{flex:1}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:15px 30px;background:white;box-shadow:0 2px 15px rgba(0,0,0,.1)}
    .menu-btn{background:none;border:none;font-size:1.6rem;cursor:pointer}
    .content{padding:30px}
    h1{color:#2c3e50;margin-bottom:25px;font-size:1.9rem}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}
    .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;font-size:0.95rem;transition:.2s}
    .btn-primary{background:var(--primary);color:white}
    .btn-success{background:var(--success);color:white}
    .btn-danger{background:var(--danger);color:white}
    .btn-sm{padding:6px 12px;font-size:0.85rem}
    .filters{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;align-items:center}
    .filters input,.filters select{padding:10px;border:1px solid #ddd;border-radius:6px;font-size:1rem}
    .bulk-bar{background:#e3f2fd;padding:12px;border-radius:8px;margin-bottom:20px;display:none;justify-content:space-between;align-items:center}
    .bulk-bar.show{display:flex}
    .table-container{background:white;border-radius:12px;overflow:hidden;box-shadow:0 5px 20px rgba(0,0,0,.1)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #eee}
    th{background:#f8f9fa;font-weight:600;color:#555;cursor:pointer}
    th:hover{background:#f1f3f5}
    tr:hover{background:#f8f9fa}
    .status-draft{background:#f8f9fa;color:#6c757d}
    .status-pending{background:#fff3cd;color:#856404}
    .status-approved{background:#d4edda;color:#155724}
    .status-partially_received{background:#d1ecf1;color:#0c5460}
    .status-received{background:#d4edda;color:#155724}
    .status-cancelled{background:#f8d7da;color:#721c24}
    .status-draft,.status-pending,.status-approved,.status-partially_received,.status-received,.status-cancelled{padding:5px 10px;border-radius:20px;font-size:0.8rem}
    .pagination{display:flex;justify-content:space-between;align-items:center;margin-top:20px}
    .pagination button{padding:8px 16px;border:1px solid #ddd;background:#f8f9fa;border-radius:6px;cursor:pointer}
    .pagination button:disabled{background:#eee;color:#999;cursor:not-allowed}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2000;justify-content:center;align-items:center}
    .modal.open{display:flex}
    .modal-content{background:white;padding:35px;border-radius:12px;width:90%;max-width:900px;max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .close-modal{position:absolute;top:15px;right:20px;background:none;border:none;font-size:32px;cursor:pointer;color:#999}
    .close-modal:hover{color:#000}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:500}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px}
    .line-items{margin-top:20px}
    .line-item{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr auto;gap:10px;padding:10px 0;border-bottom:1px solid #eee;align-items:center}
    .line-item input{padding:6px;border:1px solid #ddd;border-radius:4px}
    .sidebar-backdrop{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      z-index:998;
      opacity:0;
      transition:opacity .3s;
      pointer-events:none;
    }
    .sidebar-backdrop.show{
      display:block;
      opacity:1;
      pointer-events:auto;
    }
    .mobile-card-view{display:none}
    .mobile-card{
      background:white;
      padding:16px;
      border-radius:12px;
      margin-bottom:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
      border-left:4px solid var(--primary);
    }
    .mobile-card-header{
      display:flex;
      justify-content:space-between;
      align-items:start;
      margin-bottom:12px;
      padding-bottom:12px;
      border-bottom:1px solid #f0f0f0;
    }
    .mobile-card-title{font-weight:700;color:var(--dark);font-size:1rem}
    .mobile-card-row{
      display:flex;
      justify-content:space-between;
      padding:8px 0;
      border-bottom:1px solid #f0f0f0;
    }
    .mobile-card-row:last-child{border-bottom:none}
    .mobile-card-label{color:var(--muted);font-size:0.9rem}
    .mobile-card-value{font-weight:600;color:var(--dark)}
    .mobile-card-actions{
      display:flex;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .mobile-card-actions .btn{flex:1;min-width:80px}
    @media(max-width:768px){
      .sidebar{
        position:fixed;
        top:0;
        left:-260px;
        height:100vh;
        z-index:999;
        transition:left .3s;
        box-shadow:2px 0 20px rgba(0,0,0,.2);
      }
      .sidebar.open{left:0}
      .topbar{
        flex-wrap:wrap;
        gap:10px;
        padding:12px 16px;
      }
      .global-search{width:100%;margin-bottom:8px}
      .content{padding:16px}
      h1{font-size:1.5rem;margin-bottom:20px}
      .page-header{
        flex-direction:column;
        gap:12px;
      }
      .page-header .btn{width:100%}
      .filters{
        flex-direction:column;
        gap:10px;
      }
      .filters > *{width:100%}
      .filters input,.filters select{
        padding:14px;
        font-size:1rem;
        min-height:44px;
      }
      .table-container{display:none}
      .mobile-card-view{display:block}
      .bulk-bar{
        flex-direction:column;
        gap:12px;
        padding:16px;
      }
      .bulk-bar > div{
        display:flex;
        flex-direction:column;
        gap:8px;
        width:100%;
      }
      .bulk-bar .btn{width:100%}
      .pagination{
        flex-direction:column;
        gap:10px;
      }
      .pagination button{
        width:100%;
        padding:12px;
        min-height:44px;
      }
      .modal-content{
        width:100%;
        max-width:100%;
        height:100vh;
        max-height:100vh;
        border-radius:0;
        padding:20px 16px;
      }
      .form-row{grid-template-columns:1fr}
      .form-group input,.form-group select,.form-group textarea{
        padding:14px;
        font-size:1rem;
        min-height:44px;
      }
      .line-item{
        grid-template-columns:1fr;
        gap:12px;
      }
      .line-item input{
        padding:10px;
        min-height:44px;
      }
      .btn{
        padding:12px 16px;
        min-height:44px;
        font-size:1rem;
      }
    }
    @media(max-width:480px){
      .content{padding:12px}
      h1{font-size:1.3rem}
      .mobile-card{padding:12px}
    }
    .totals{text-align:right;margin:20px 0;font-weight:500;font-size:1.1rem}
    .toast{position:fixed;bottom:30px;right:30px;background:#333;color:white;padding:16px 28px;border-radius:8px;opacity:0;transition:.3s;z-index:3000;box-shadow:0 8px 25px rgba(0,0,0,.3)}
    .toast.show{opacity:1;transform:translateY(-10px)}
  </style>
</head>
<body>
<div class="app">
  <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeSidebar()"></div>
  <aside class="sidebar" id="sidebar">
    <div class="logo">InventoryPro</div>
    <ul>
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="inventory.html">Inventory</a></li>
      <li><a href="suppliers.html">Suppliers</a></li>
      <li class="active"><a href="#">Purchase Orders</a></li>
      <li><a href="adjustments.html">Adjustments</a></li>
      <li><a href="reports.html">Reports</a></li>
      <li><a href="settings.html">Settings</a></li>
    </ul>
  </aside>

  <div class="main">
    <header class="topbar">
      <button class="menu-btn" onclick="toggleSidebar()" aria-label="Toggle menu">â˜°</button>
      <h2>Purchase Orders</h2>
      <div>
        <select onchange="document.body.className=this.value;localStorage.setItem('theme',this.value)">
          <option value="">Light</option>
          <option value="dark">Dark</option>
        </select>
        <span style="margin-left:20px;background:var(--primary);color:white;padding:10px 14px;border-radius:50%;font-weight:bold">AD</span>
      </div>
    </header>

    <main class="content">
      <div class="page-header">
        <h1>Purchase Orders</h1>
        <button class="btn btn-primary" onclick="openCreatePO()">+ Create Purchase Order</button>
      </div>

      <div class="filters">
        <input type="text" placeholder="Search..." id="searchInput" onkeyup="applyFilters()">
        <select id="statusFilter" onchange="applyFilters()">
          <option value="">All Status</option>
          <option value="draft">Draft</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="partially_received">Partially Received</option>
          <option value="received">Received</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <button class="btn btn-sm" onclick="clearFilters()">Clear</button>
      </div>

      <div class="table-container">
        <table id="purchasesTable">
          <thead>
            <tr>
              <th>PO #</th>
              <th>Status</th>
              <th>Supplier</th>
              <th>Created</th>
              <th>Expected</th>
              <th>Items</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="poTableBody"></tbody>
        </table>
      </div>
      <div class="mobile-card-view" id="mobileCardView"></div>
    </main>
  </div>

  <!-- Create/Edit PO Modal -->
  <div class="modal" id="poModal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeModal()">X</button>
      <h2 id="modalTitle">Create Purchase Order</h2>
      <form onsubmit="savePO(event)">
        <input type="hidden" id="poId">

        <div class="form-row">
          <div class="form-group">
            <label>PO Number</label>
            <input type="text" id="poNumber" readonly>
          </div>
          <div class="form-group">
            <label>Supplier *</label>
            <input type="text" id="supplierInput" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Currency</label>
            <select id="currency">
              <option value="USD">$ USD</option>
              <option value="EUR">EUR</option>
            </select>
          </div>
          <div class="form-group">
            <label>Expected Delivery</label>
            <input type="date" id="deliveryDate">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Payment Terms</label>
            <select id="paymentTerms">
              <option>Net 30</option>
              <option>Net 60</option>
              <option>Prepaid</option>
            </select>
          </div>
          <div class="form-group">
            <label>Warehouse</label>
            <select id="warehouse">
              <option>Warehouse A</option>
              <option>Warehouse B</option>
            </select>
          </div>
        </div>

        <h4 style="margin:30px 0 15px">Line Items</h4>
        <div id="lineItemsContainer"></div>
        <button type="button" class="btn" onclick="addLineItem()">+ Add Item</button>

        <div class="totals">
          <div>Subtotal: <span id="subtotal">$0.00</span></div>
          <div>Tax: <span id="totalTax">$0.00</span></div>
          <div>Discount: <span id="totalDiscount">$0.00</span></div>
          <div>Shipping: <input type="number" id="shippingCost" value="0" step="0.01" oninput="updateTotals()" style="width:100px;padding:6px"></div>
          <hr>
          <div style="font-size:1.3rem;font-weight:bold">Grand Total: <span id="grandTotal">$0.00</span></div>
        </div>

        <div style="text-align:right;margin-top:30px">
          <button type="button" class="btn" onclick="saveDraft()">Save as Draft</button>
          <button type="button" class="btn btn-success" onclick="saveAndSend()">Save & Send</button>
          <button type="button" class="btn btn-danger" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>
</div>

<script>
  // DUMMY DATA - FULLY WORKING
  let pos = JSON.parse(localStorage.getItem('pos') || '[]');
  if(pos.length === 0){
    pos = [
      {id:1, poNumber:'PO-2025-001', status:'draft', supplier:'TechSupplier Inc', createdDate:'2025-12-09', expectedDate:'2025-12-20', itemsCount:3, totalValue:5499.97, lineItems:[
        {name:"Laptop Dell XPS", qty:2, unitCost:1999.99, tax:0, discount:0},
        {name:"Wireless Mouse", qty:50, unitCost:24.99, tax:0, discount:10}
      ]},
      {id:2, poNumber:'PO-2025-002', status:'pending', supplier:'Global Electronics', createdDate:'2025-12-08', expectedDate:'2025-12-18', itemsCount:5, totalValue:8999.95, lineItems:[
        {name:"USB-C Hub", qty:100, unitCost:45.00, tax:8, discount:5}
      ]}
    ];
    localStorage.setItem('pos', JSON.stringify(pos));
  }

  function renderTable() {
    const tbody = document.getElementById('poTableBody');
    tbody.innerHTML = pos.map(po => `
      <tr>
        <td><strong>${po.poNumber}</strong></td>
        <td><span class="status-${po.status}">${po.status.replace('_',' ')}</span></td>
        <td>${po.supplier}</td>
        <td>${po.createdDate}</td>
        <td>${po.expectedDate}</td>
        <td>${po.itemsCount}</td>
        <td>$${po.totalValue.toFixed(2)}</td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="editPO(${po.id})">Edit</button>
          <button class="btn btn-sm btn-success" onclick="viewPO(${po.id})">View</button>
          <button class="btn btn-sm btn-warning" onclick="receivePO(${po.id})">Receive</button>
          <button class="btn btn-sm btn-danger" onclick="deletePO(${po.id})">Delete</button>
        </td>
      </tr>
    `).join('');
  }

  function openCreatePO(po = null) {
    const isEdit = !!po;
    document.getElementById('modalTitle').textContent = isEdit ? 'Edit Purchase Order' : 'Create Purchase Order';
    document.getElementById('poId').value = isEdit ? po.id : '';
    document.getElementById('poNumber').value = isEdit ? po.poNumber : 'PO-' + new Date().getFullYear() + '-' + String(pos.length + 1).padStart(4,'0');
    document.getElementById('supplierInput').value = isEdit ? po.supplier : '';
    document.getElementById('currency').value = isEdit ? (po.currency || 'USD') : 'USD';
    document.getElementById('deliveryDate').value = isEdit ? po.expectedDate : '';
    document.getElementById('paymentTerms').value = isEdit ? (po.paymentTerms || 'Net 30') : 'Net 30';
    document.getElementById('warehouse').value = isEdit ? (po.warehouse || 'Warehouse A') : 'Warehouse A';
    document.getElementById('shippingCost').value = isEdit ? (po.shipping || 0) : 0;

    const container = document.getElementById('lineItemsContainer');
    container.innerHTML = '';
    const items = isEdit ? po.lineItems : [];
    if(items.length === 0) addLineItem();
    else items.forEach(item => addLineItem(item));

    updateTotals();
    document.getElementById('poModal').classList.add('open');
  }

  function addLineItem(item = null) {
    const div = document.createElement('div');
    div.className = 'line-item';
    div.innerHTML = `
      <input type="text" placeholder="Item Name" value="${item ? item.name : ''}" required>
      <input type="number" placeholder="Qty" min="1" value="${item ? item.qty || 1 : 1}" oninput="updateTotals()">
      <input type="number" placeholder="Unit Cost" step="0.01" value="${item ? item.unitCost || '' : ''}" oninput="updateTotals()">
      <input type="number" placeholder="Tax %" step="0.01" value="${item ? item.tax || 0 : 0}" oninput="updateTotals()">
      <input type="number" placeholder="Discount %" step="0.01" value="${item ? item.discount || 0 : 0}" oninput="updateTotals()">
      <input type="date" value="${item ? item.deliveryDate || '' : ''}">
      <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove();updateTotals()">Remove</button>
    `;
    document.getElementById('lineItemsContainer').appendChild(div);
  }

  function updateTotals() {
    let subtotal = 0, tax = 0, discount = 0;
    document.querySelectorAll('.line-item').forEach(row => {
      const qty = parseFloat(row.children[1].value) || 0;
      const cost = parseFloat(row.children[2].value) || 0;
      const taxRate = parseFloat(row.children[3].value) || 0;
      const discRate = parseFloat(row.children[4].value) || 0;
      subtotal += qty * cost;
      tax += qty * cost * (taxRate/100);
      discount += qty * cost * (discRate/100);
    });
    const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
    const grand = subtotal + tax - discount + shipping;

    document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('totalTax').textContent = '$' + tax.toFixed(2);
    document.getElementById('totalDiscount').textContent = '$' + discount.toFixed(2);
    document.getElementById('grandTotal').textContent = '$' + grand.toFixed(2);
  }

  function savePO(e) {
    e.preventDefault();
    const items = [];
    document.querySelectorAll('.line-item').forEach(row => {
      items.push({
        name: row.children[0].value,
        qty: parseInt(row.children[1].value),
        unitCost: parseFloat(row.children[2].value),
        tax: parseFloat(row.children[3].value),
        discount: parseFloat(row.children[4].value),
        deliveryDate: row.children[5].value
      });
    });

    const total = items.reduce((s,i)=>s + i.qty*i.unitCost*(1+i.tax/100)*(1-i.discount/100),0) + 
                  (parseFloat(document.getElementById('shippingCost').value)||0);

    const po = {
      id: document.getElementById('poId').value || Date.now(),
      poNumber: document.getElementById('poNumber').value,
      supplier: document.getElementById('supplierInput').value,
      currency: document.getElementById('currency').value,
      expectedDate: document.getElementById('deliveryDate').value,
      paymentTerms: document.getElementById('paymentTerms').value,
      warehouse: document.getElementById('warehouse').value,
      lineItems: items,
      itemsCount: items.length,
      totalValue: total,
      status: document.getElementById('poId').value ? pos.find(p=>p.id==document.getElementById('poId').value).status : 'draft',
      createdDate: document.getElementById('poId').value ? pos.find(p=>p.id==document.getElementById('poId').value).createdDate : new Date().toISOString().slice(0,10)
    };

    if(document.getElementById('poId').value){
      pos = pos.map(p => p.id == po.id ? po : p);
      showToast('PO updated successfully!');
    } else {
      pos.push(po);
      showToast('PO created successfully!');
    }
    localStorage.setItem('pos', JSON.stringify(pos));
    closeModal();
    renderTable();
  }

  function saveDraft() {
    document.getElementById('poForm').onsubmit = function(e) {
      e.preventDefault();
      savePO(e);
      showToast('Saved as Draft');
    };
    document.getElementById('poForm').requestSubmit();
  }

  function saveAndSend() {
    document.getElementById('poForm').onsubmit = function(e) {
      e.preventDefault();
      savePO(e);
      showToast('PO sent for approval!');
    };
    document.getElementById('poForm').requestSubmit();
  }

  function editPO(id) {
    const po = pos.find(p => p.id === id);
    if(!po) return;
    openCreatePO(po);
  }

  function viewPO(id) { showToast('Viewing PO details'); }
  function receivePO(id) { showToast('Opening GRN for PO'); }
  function deletePO(id) {
    if(confirm('Delete this PO?')) {
      pos = pos.filter(p => p.id !== id);
      localStorage.setItem('pos', JSON.stringify(pos));
      renderTable();
      showToast('PO deleted');
    }
  }

  function applyFilters() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    const filtered = pos.filter(po => 
      (po.poNumber.toLowerCase().includes(term) || po.supplier.toLowerCase().includes(term)) &&
      (!status || po.status === status)
    );
    document.getElementById('poTableBody').innerHTML = filtered.map(po => `
      <tr>
        <td><strong>${po.poNumber}</strong></td>
        <td><span class="status-${po.status}">${po.status.replace('_',' ')}</span></td>
        <td>${po.supplier}</td>
        <td>${po.createdDate}</td>
        <td>${po.expectedDate}</td>
        <td>${po.itemsCount}</td>
        <td>$${po.totalValue.toFixed(2)}</td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="editPO(${po.id})">Edit</button>
          <button class="btn btn-sm btn-success" onclick="viewPO(${po.id})">View</button>
          <button class="btn btn-sm btn-warning" onclick="receivePO(${po.id})">Receive</button>
          <button class="btn btn-sm btn-danger" onclick="deletePO(${po.id})">Delete</button>
        </td>
      </tr>
    `).join('');
  }

  function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    applyFilters();
  }

  function openModal(id){document.getElementById(id).classList.add('open')}
  function closeModal(){document.querySelectorAll('.modal').forEach(m=>m.classList.remove('open'))}
  function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}

  document.querySelectorAll('.modal').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)closeModal()}));
  document.body.className = localStorage.getItem('theme')||'';
  renderTable();
  
  // Sidebar functions
  function toggleSidebar(){
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('sidebarBackdrop');
    sidebar.classList.toggle('open');
    backdrop.classList.toggle('show');
  }
  function closeSidebar(){
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('sidebarBackdrop');
    sidebar.classList.remove('open');
    backdrop.classList.remove('show');
  }
  
  // Close sidebar on nav click
  document.querySelectorAll('.sidebar a').forEach(link => {
    link.addEventListener('click', () => {
      if(window.innerWidth <= 768) closeSidebar();
    });
  });
</script>
</body>
</html>